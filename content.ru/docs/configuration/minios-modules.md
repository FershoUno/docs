---
title: Пакетное создание модулей
type: docs
weight: 4
---

# Пакетное создание модулей

<div style="text-align: justify">
Приложение minios-modules предназначено для пакетного создания модулей. Принцип действия аналогичен сборке модулей при установке системы в minios-live.
<!--more-->

## Создание простого модуля

Для создания простого модуля вам необходимо создать папку modules, в ней создать папку с именем модуля, например:
`mkdir -p modules/10-gparted`
Далее необходимо создать файл `install`, внутри которого описать команды, необходимые для установки программы:
```
#!/bin/bash

apt update
apt install -y gparted

```
Далее вернитесь в папку, где находится папка `modules` и запустите команду сборки:
`minios-modules build_modules`
В результате выполнения этой команды вы получите модуль с именем **10-gparted-amd64-zstd.sb**. Аналогично вы можете создать папки и скрипты для сборки других модулей. Указанная команда соберёт их последовательно в алфавитном порядке папок в папке <strong>modules</strong>.

## Создание сложных модулей

**minios-modules** позволяет создавать и более сложные модули. Помимо файла **install** в папке скриптов модуля могут быть файлы **build**, **preinstall**, **postinstall**, **is\_dkms\_build**, а так же папки **rootcopy-install**, **rootcopy-postinstall** и **patches**. Очерёдность выполнения скриптов при сборке модулей следующая:
1. preinstall - *выполнение операций перед установкой, необязательный*
2. rootcopy-install - *из этой папки перед установкой копируются файлы в корень системы будущего модуля*
3. install - *основной скрипт сборки модуля*
* *После выполнения скрипта установки запускается процесс автоматической очистки будущего модуля от мусора*
4. patches - <em>папка для копирования файлов в папку **patches** в корне модуля. Её копирование происходит только при наличии скрипта <strong>build</strong>. В неё можно положить патчи, что понятно из названия, для применения к исходным кодам в скрипте.</em>
5. build - <em>если вы планируете компилировать программы, вы должны поместить все действия в этот скрипт. Перед выполнением **build** файлы, полученные при установке, автоматически сохраняются в архиве squashfs и распаковываются в папку squashfs-root для того, чтобы пакеты, необходимые для сборки не попали в модуль. В конце скрипта **build** необходимо добавить операции для копирования скомпилированных файлов в папку squashfs-root, а в самом конце упаковать в squashfs, так как на этом шаге не предусмотрена автоматическая сборка модуля.</em>
6. rootcopy-postinstall - если очистка удалила что-то лишнее, вы можете это вернуть обратно с помощью этой папки, либо скопировать какие-нибудь файлы, которые нельзя было добавить в систему до установки
7. postinstall - *выполнение действий после установки системы. Как правило, это дополнительная очистка от мусора.*

Отдельно стоит отметить файл <strong>is\_dkms\_build</strong>. Пустой файл с этим именем необходимо создать, если вы используете скрипт **build** для компиляции модулей ядра (*да, я знаю, что они могут не иметь отношения к dkms, но исторически сложилось такое наименование*), тогда в модуль попадёт только содержимое /usr/lib/modules.

Пример скриптов для сборки модуля с использованием **build** с папкой <strong>patches</strong>: https://github.com/minios-linux/minios-live/tree/master/linux-live/scripts/04-flux-desktop

Пример скриптов для сборки модуля с использованием **build** и <strong>is\_dkms\_build</strong>: https://github.com/minios-linux/minios-live/tree/master/linux-live/scripts/10-virtualbox-6.1

Из-за того, что имя основного пользователя в MiniOS динамическое и может быть любым (см ...), при сборке модуля, который добавляет в систему группу, которую затем нужно будет назначить основному пользователю (например,
vboxusers для модуля virtualbox) для того, чтобы он мог запускать программу без прав root, необходимо создать сервис systemd. Этот сервис будет добавлять основного пользователя в нужную группу, если он не был добавлен ранее, при старте системы. Например:
```
APP="virtualbox"
APP_NAME="VirtualBox"
APP_GROUP="vboxusers"

cat <<EOF >/usr/bin/$APP-allowuser.sh
#!/bin/bash
if ! grep $APP_GROUP /etc/group | grep \$(id -nu 1000) >/dev/null; then
    usermod -a -G $APP_GROUP \$(id -nu 1000)
fi
EOF
chmod +x /usr/bin/$APP-allowuser.sh
cat <<EOF >/usr/lib/systemd/system/$APP-allowuser.service
[Unit]
Description=Allow user to use $APP_NAME
#After=network.target
[Service]
Type=oneshot
ExecStart=/usr/bin/$APP-allowuser.sh
RemainAfterExit=true
ExecStop=
StandardOutput=journal
[Install]
WantedBy=multi-user.target
EOF
systemctl enable $APP-allowuser.service
```
Полный вариант скрипта: https://github.com/minios-linux/minios-live/blob/master/linux-live/scripts/10-virtualbox-6.1/install
</div>